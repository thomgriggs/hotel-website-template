---
import Layout from '../layouts/Layout.astro';
import HeroSlider from '../components/HeroSlider.astro';
import { client, queries, urlFor } from '../lib/sanity';
import { getOptimizedImageUrl, getUnsplashImage } from '../lib/imageOptimization';

// Fetch site settings and featured content from Sanity
const siteSettings = await client.fetch(queries.siteSettings);
const homepage = await client.fetch(queries.homepage);
const featuredRooms = await client.fetch(queries.featuredRooms);
const featuredDining = await client.fetch(queries.featuredDining);
const featuredAmenities = await client.fetch(queries.featuredAmenities);

// Extract homepage content
const pageTitle = homepage?.pageTitle || 'Home - Paradise Hotel';
const heroSubtitle = homepage?.heroSubtitle || 'Welcome to';
const heroTitle = homepage?.heroTitle || 'Paradise Hotel';
const heroImage = homepage?.heroImage;
const mainHeading = homepage?.mainHeading || 'Luxury Redefined';
const mainDescription = homepage?.mainDescription || 'Experience unparalleled luxury and world-class service in our stunning beachfront resort. From elegant accommodations to exceptional dining, every detail is crafted for your comfort.';
const primaryButtonText = homepage?.primaryButtonText || 'View Rooms';
const primaryButtonUrl = homepage?.primaryButtonUrl || '/rooms';
const secondaryButtonText = homepage?.secondaryButtonText || 'Book Now';
const secondaryButtonUrl = homepage?.secondaryButtonUrl || '/contact';
const roomsSectionTitle = homepage?.roomsSectionTitle || 'Featured Accommodations';
const diningSectionTitle = homepage?.diningSectionTitle || 'Exceptional Dining';
const amenitiesSectionTitle = homepage?.amenitiesSectionTitle || 'World-Class Amenities';

// Create slides data for the hero slider
const heroSlides = [
	{
		id: 'luxury-experience',
		title: heroTitle || 'Paradise Hotel',
		subtitle: heroSubtitle || 'Welcome to',
		description: mainDescription || 'Experience unparalleled luxury and world-class service in our stunning beachfront resort. From elegant accommodations to exceptional dining, every detail is crafted for your comfort.',
		image: heroImage ? getOptimizedImageUrl(heroImage, 1920, 1080, 'webp') : getUnsplashImage('luxury hotel', 1920, 1080, 'webp'),
		ctaText: primaryButtonText || 'View Rooms',
		ctaUrl: primaryButtonUrl || '/rooms',
		ctaSecondaryText: secondaryButtonText || 'Book Now',
		ctaSecondaryUrl: secondaryButtonUrl || '/contact'
	},
	{
		id: 'dining-experience',
		title: 'Exceptional Dining',
		subtitle: 'Culinary Excellence',
		description: 'Indulge in world-class cuisine at our award-winning restaurants. From fine dining to casual fare, our culinary team creates unforgettable experiences.',
		image: getUnsplashImage('restaurant dining', 1920, 1080, 'webp'),
		ctaText: 'Explore Dining',
		ctaUrl: '/dining',
		ctaSecondaryText: 'Make Reservation',
		ctaSecondaryUrl: '/contact'
	},
	{
		id: 'amenities-experience',
		title: 'World-Class Amenities',
		subtitle: 'Relax & Rejuvenate',
		description: 'Discover our comprehensive amenities including spa services, fitness center, infinity pool, and concierge services designed for your ultimate comfort.',
		image: getUnsplashImage('hotel spa', 1920, 1080, 'webp'),
		ctaText: 'View Amenities',
		ctaUrl: '/amenities',
		ctaSecondaryText: 'Spa Services',
		ctaSecondaryUrl: '/amenities'
	},
	{
		id: 'location-experience',
		title: 'Prime Location',
		subtitle: 'Paradise Awaits',
		description: 'Located in the heart of paradise with easy access to beaches, attractions, and cultural sites. Experience the best of both luxury and adventure.',
		image: getUnsplashImage('luxury hotel location', 1920, 1080, 'webp'),
		ctaText: 'Explore Location',
		ctaUrl: '/location',
		ctaSecondaryText: 'Get Directions',
		ctaSecondaryUrl: '/contact'
	}
];

// Helper function to get image URL safely
function getImageUrl(image: any, width: number, height: number): string {
  if (!image?.asset?._ref) {
    return getUnsplashImage('luxury hotel', width, height, 'webp');
  }
  return urlFor(image).width(width).height(height).format('webp').quality(85).url();
}

// Unsplash image helper function - now using optimized format
function getUnsplashImage(query: string, width: number = 800, height: number = 600, format: string = 'webp'): string {
  // Use Unsplash Source API with optimization
  const seed = query.replace(/\s+/g, '-').toLowerCase();
  return `https://images.unsplash.com/photo-1566073771259-6a8506099945?w=${width}&h=${height}&fit=crop&crop=center&auto=format&q=80&fm=${format}`;
}

// Helper function to map amenity categories to image types
function getAmenityImageType(category: string): string {
  const categoryMap: { [key: string]: string } = {
    'Spa & Wellness': 'spa',
    'Fitness': 'gym',
    'Pool': 'pool',
    'Dining': 'restaurant',
    'Entertainment': 'bar',
    'Business': 'conference',
    'Recreation': 'garden',
    'Services': 'lobby',
  };
  
  return categoryMap[category] || 'hotel';
}
---

<Layout 
	title={pageTitle}
	description={mainDescription}
	image={heroSlides[0].image}
	type="Hotel"
	keywords={[
		"luxury hotel",
		"beachfront resort", 
		"fine dining",
		"spa services",
		"luxury accommodations",
		"hotel rooms",
		"restaurant",
		"amenities",
		"paradise hotel"
	]}
>
	<!-- Preview Mode Indicator (client-side) -->
	
	<!-- Debug Info (client-side) -->
	<div id="debug-info" style="position: fixed; top: 40px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; font-size: 12px; z-index: 998; border-radius: 4px; display: none;">
		Debug: Preview Mode Active
	</div>
	
	<main id="main-content">
		<!-- Hero Slider -->
		<HeroSlider slides={heroSlides} />

		<!-- Main Content -->
		<section id="main" data-sanity-edit-section={`${homepage?._id}#main`}>
			<div class="wrapper">
				<div class="summary">
					<div class="inner">
						<h1 data-sanity-edit-field={`${homepage?._id}#mainHeading`}><span>{mainHeading}</span></h1>
						<p data-sanity-edit-field={`${homepage?._id}#mainDescription`}>{mainDescription}</p>
						<div class="buttons">
							<div><a class="btn" href={primaryButtonUrl} data-sanity-edit-field={`${homepage?._id}#primaryButtonText`}>{primaryButtonText}</a></div>
							<div><a class="btn btn-secondary" href={secondaryButtonUrl} data-sanity-edit-field={`${homepage?._id}#secondaryButtonText`}>{secondaryButtonText}</a></div>
						</div>
					</div>
				</div>
				
				<!-- Featured Rooms -->
				{featuredRooms.length > 0 && (
					<div class="section">
						<h2 class="section-title" data-sanity-edit-field={`${homepage?._id}#roomsSectionTitle`}>{roomsSectionTitle}</h2>
						<div class="post-group">
							{featuredRooms.slice(0, 2).map((room: any) => (
								<article class="post post-repeat">
									<div class="inner">
										<div class="post-img">
											{room.images && room.images.length > 0 ? (
												<img 
													src={urlFor(room.images[0]).width(800).height(600).format('webp').quality(85).url()} 
													alt={room.images[0].alt || room.title}
													loading="lazy"
													data-sanity-edit-field={`${room._id}#images`}
												/>
											) : (
												<img 
													src={getUnsplashImage('luxury hotel bedroom', 800, 600, 'webp')} 
													alt={room.title}
													loading="lazy"
													data-sanity-edit-field={`${room._id}#images`}
												/>
											)}
										</div>
										<div class="post-content">
											<div class="inner">
												<h3 data-sanity-edit-field={`${room._id}#title`}><span>{room.title}</span></h3>
												<span class="subtitle" data-sanity-edit-field={`${room._id}#price`}>Starting at ${room.price}/night</span>
												<p data-sanity-edit-field={`${room._id}#description`}>{room.description}</p>
												{room.amenities && room.amenities.length > 0 && (
													<ul class="alt-list" data-sanity-edit-field={`${room._id}#amenities`}>
														{room.amenities.slice(0, 3).map((amenity: string) => (
															<li>{amenity}</li>
														))}
													</ul>
												)}
												<div class="buttons">
													<div>
														<a class="btn" href={`/rooms/${room.slug.current}`} data-sanity-edit-field={`${room._id}#viewDetailsButton`}>
															View Details
														</a>
													</div>
												</div>
											</div>
										</div>
									</div>
								</article>
							))}
						</div>
					</div>
				)}
				
				<!-- Featured Dining -->
				{featuredDining.length > 0 && (
					<div class="section">
						<h2 class="section-title" data-sanity-edit-field={`${homepage?._id}#diningSectionTitle`}>{diningSectionTitle}</h2>
						<div class="post-group">
							{featuredDining.slice(0, 2).map((restaurant: any) => (
								<article class="post post-repeat">
									<div class="inner">
										<div class="post-img">
											{restaurant.images && restaurant.images.length > 0 ? (
												<img 
													src={urlFor(restaurant.images[0]).width(800).height(600).url()} 
													alt={restaurant.images[0].alt || restaurant.name}
													data-sanity-edit-field={`${restaurant._id}#images`}
												/>
											) : (
												<img 
													src={getUnsplashImage('restaurant dining', 800, 600)} 
													alt={restaurant.name}
													data-sanity-edit-field={`${restaurant._id}#images`}
												/>
											)}
										</div>
										<div class="post-content">
											<div class="inner">
												<h3 data-sanity-edit-field={`${restaurant._id}#name`}><span>{restaurant.name}</span></h3>
												<span class="subtitle" data-sanity-edit-field={`${restaurant._id}#cuisine`}>{restaurant.cuisine} â€¢ {restaurant.priceRange}</span>
												<p data-sanity-edit-field={`${restaurant._id}#description`}>{restaurant.description}</p>
												<div class="buttons">
													<div>
														<a class="btn" href={`/dining/${restaurant.slug.current}`} data-sanity-edit-field={`${restaurant._id}#viewMenuButton`}>
															View Menu
														</a>
													</div>
												</div>
											</div>
										</div>
									</div>
								</article>
							))}
						</div>
					</div>
				)}
				
				<!-- Featured Amenities -->
				{featuredAmenities.length > 0 && (
					<div class="section">
						<h2 class="section-title" data-sanity-edit-field={`${homepage?._id}#amenitiesSectionTitle`}>{amenitiesSectionTitle}</h2>
						<div class="post-group">
							{featuredAmenities.slice(0, 2).map((amenity: any) => (
								<article class="post post-repeat">
									<div class="inner">
										<div class="post-img">
											{amenity.images && amenity.images.length > 0 ? (
												<img 
													src={urlFor(amenity.images[0]).width(800).height(600).url()} 
													alt={amenity.images[0].alt || amenity.title}
													data-sanity-edit-field={`${amenity._id}#images`}
												/>
											) : (
												<img 
													src={getUnsplashImage(getAmenityImageType(amenity.category), 800, 600)} 
													alt={amenity.title}
													data-sanity-edit-field={`${amenity._id}#images`}
												/>
											)}
										</div>
										<div class="post-content">
											<div class="inner">
												<h3 data-sanity-edit-field={`${amenity._id}#title`}><span>{amenity.title}</span></h3>
												<span class="subtitle" data-sanity-edit-field={`${amenity._id}#category`}>{amenity.category}</span>
												<p data-sanity-edit-field={`${amenity._id}#description`}>{amenity.description}</p>
												{amenity.features && amenity.features.length > 0 && (
													<ul class="alt-list" data-sanity-edit-field={`${amenity._id}#features`}>
														{amenity.features.slice(0, 3).map((feature: string) => (
															<li>{feature}</li>
														))}
													</ul>
												)}
												<div class="buttons">
													<div>
														<a class="btn" href={`/amenities/${amenity.slug.current}`} data-sanity-edit-field={`${amenity._id}#learnMoreButton`}>
															Learn More
														</a>
													</div>
												</div>
											</div>
										</div>
									</div>
								</article>
							))}
						</div>
					</div>
				)}
			</div>
		</section>
	</main>
</Layout>

<style>
	.section {
		margin: 4rem 0;
	}
	
	.section-title {
		text-align: center;
		margin-bottom: 3rem;
		color: var(--color_navy);
		font-size: var(--title_heading-2);
	}
	
	.post-group {
		display: grid;
		gap: 3rem;
	}
	
	@media (min-width: 768px) {
		.post-group {
			grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
		}
	}
</style>
